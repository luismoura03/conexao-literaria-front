<template>
  <q-card flat bordered class="q-pa-md">
    <q-card-section>
        <div class="text-h6">Lista de Livros</div>
    </q-card-section>
    <q-separator />
    <q-card-section>
      <BooksTable
      :books="books"
      :columns="columns"
      :authors="authors"
      @edit="openEditDialog"
      @delete="deleteBooks"
      />

      <div v-if="loading">Carregando...</div>
      <div v-if="error">Erro ao buscar livros: {{ error.message }}</div>

      <div class="input-container">
      <q-input
      v-model="newBookTitle"
      label="Novo Livro"
      filled
      style="max-width: 300px;"
      />
      <div class="custom-select">
      <q-select
      v-model="newBookAuthorId"
      :options="authorsOptions"
      label="Selecione o Autor"
      filled
      style="height: 42px;"
      />
      </div>
      <q-btn
        icon="add"
        label="Adicionar Livro"
        color="positive"
        @click="addBook()"
        class="q-mt-md"
      />
      </div>
    </q-card-section>
    <EditBookDialog
    :bookData="editBookData"
    :authorsOptions="authorsOptions"
    :isOpen="isEditDialogOpen"
    @close="closeEditDialog"
    @save="saveBookChanges"
    />

  </q-card>
</template>

<script setup>
import { ref, watch } from 'vue'
import { GET_BOOKS } from '../graphql/queries/queriesBooks/bookQueries'
import { GET_AUTHORS } from '../graphql/queries/queriesAuthors/authorsQueries'
import { CREATE_BOOK } from '../graphql/mutations/mutationsBooks/createBook'
import { useQuery, useMutation } from '@vue/apollo-composable'
import BooksTable from './tables/BooksTable.vue'
import EditBookDialog from './EditDialog/EditBookDialog.vue'

const columns = [
  {name: 'id', label: 'ID', field: 'id', align: 'left'},
  {name: 'title', label: 'Livros', field: 'title', align: 'left'},
  {name: 'author', label: 'Autores', field: row => row.author?.name ?? 'Desconhecido', align:'left'},
  {name: 'actions', label: 'Ações', align: 'left'}
]


const books = ref([])//lista de livros
const authors = ref([])//lista de autores
const authorsOptions = ref([])//lista de opções de autores para select
const newBookTitle = ref('')
const newBookAuthorId = ref(null)
const editBookData = ref({ id: '', title: '', authorId: '' })
const isEditDialogOpen = ref(false)
const loading = ref(false)
const error = ref(null)


//usa apollo composable(useQuery) para consultar livros do backend com a query GET_BOOKS
const { result: resultBooks } = useQuery(GET_BOOKS, null, {
  fetchPolicy: 'network-only',
  onError: (error) => {
    console.error('Erro ao buscar livros:', error)
  },
  onCompleted: () => loading.value = false
})

const {result: resultAuthors} = useQuery(GET_AUTHORS, null, {
  fetchPolicy: 'network-only',
  onError: (error) => {
    console.error('Erro ao buscar autores:', error)
  },
  onCompleted: () => {
    loading.value = false
    }
  }
)

const { mutate: addBookMutation } = useMutation(CREATE_BOOK, {
  onError: (mutationError) => {
    console.error('Erro ao adicionar livro:', mutationError)
    error.value = mutationError
  },
  onCompleted: () => loading.value = false
})
//tenta carregar os livros retornados pela query para a variavel books
watch(
  () => resultBooks.value,
  (newBooks) => {
    if (newBooks && newBooks.books) {
      books.value = newBooks.books
    }
    console.log('lita de livros:', books.value )
  }
)
watch(
  () => resultAuthors.value,
  (newAuthors) => {
    if(newAuthors && newAuthors.authors){
      authors.value = newAuthors.authors
      authorsOptions.value = newAuthors.authors.map(author => ({
        value: author.id,
        label: author.name
      }))
    }
  }
)
const addBook = () => {
  console.log(newBookTitle.value, newBookAuthorId.value)
  if(!newBookTitle.value|| !newBookAuthorId.value){
    alert('Preencha o titulo e o autor do livro')
    return
  }

  console.log("adicionado livro com o titulo:", newBookTitle.value)
  console.log("adicionado autor com o titulo:", newBookAuthorId.value)

  loading.value = true
  error.value = null

   addBookMutation({
    title: newBookTitle.value,
    author: newBookAuthorId.value
  }).then((result) => {
    if (result && result.data){
      books.value = [ ...books.value, {
        id: result.data.createBook.value.id,
        title: result.data.createBook.title,
        author: {
          id: result.data.createBook.author.id,
          name: result.data.createBook.author.name
        }
      }]
      newBookTitle.value = ''
      newBookAuthorId.value = null
    }
    loading.value = false
  })

  newBookTitle.value = ''
  newBookAuthorId.value = null
}

const deleteBooks = () => {
  alert('Deleting books')
}

const openEditDialog = (book) => {
  editBookData.value = { ...book }
  isEditDialogOpen.value = true
}

const closeEditDialog = () => {
  isEditDialogOpen.value = false
  editBookData.value = ({ id: '', value: '', authorId: '' })
}

const saveBookChanges = (updatedBookData) => {
  console.log('salvando dados:', updatedBookData)
  const index = books.value.findIndex(b => b.id === updatedBookData.id)
  if(index !== -1){
    books.value[index] = updatedBookData
  }
}

// const { mutate: addBookMutation } = useMutation
</script>
<style scoped>
.input-container{
  display: flex;
  align-items: center;
  margin-top: 15px ;
}
.input-container > *{
  margin-right: 10px;
}

.q-input, .q-btn, .q-select{
  height: 42px;
}

.custom-select {
  width: 22%;
  max-width: 300px;
}
</style>
